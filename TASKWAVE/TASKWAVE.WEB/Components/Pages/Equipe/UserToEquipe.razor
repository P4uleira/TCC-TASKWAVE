@page "/UserToTeam"
@rendermode InteractiveServer
@using TASKWAVE.WEB.Components.Layout
@layout NavMenu
@inject HttpClient Http

<PageTitle>Usuários para equipes</PageTitle>

<div class="sidebar" style="width:270px;">
	<NavMenuOptions Options="@Options" />
</div>

<div class="m-md-5">
	<h2>Usuários para equipe</h2>
	<h4 class="mt-3 ">Adicionar Usuários a Equipes</h4>

	<div class="d-flex mt-lg-3">
		<p style="width: 50%">Usuário</p>
		<p style="width: 50%">Equipe</p>
	</div>

	<div class="mb-3 d-flex gap-3">
		<select style="background-color: #333339" class="form-select text-white w-50" @bind="selectedUserId">
			<option value="">Selecione um usuário</option>
			@foreach (var user in userList)
			{
				<option value="@user.userID">@user.userName</option>
			}
		</select>

		<select style="background-color: #333339" class="form-select text-white w-50" @bind="selectedTeamId">
			<option value="">Selecione uma equipe</option>
			@foreach (var team in teamList)
			{
				<option value="@team.teamId">@team.teamName</option>
			}
		</select>
	</div>
	<div class="d-flex w-100 justify-content-center">
		<button style="background-color: #748CAB" class="btn text-white w-25 rounded-pill mt-xl-5 " @onclick="AssociateUserToTeam">Vincular Usuário à Equipe</button>
	</div>
	@if (!string.IsNullOrWhiteSpace(mensageResponse))
	{
		<div class="alert alert-info mt-3">@mensageResponse</div>
	}
</div>


@code {

	List<HyperLink> Options = new List<HyperLink>
	{
		new HyperLink("/EquipeCreate", "Criar Equipe", "Criar Equipe", HyperLink.TypeOfIcon.Add),
		new HyperLink("/Equipe", "Gerenciar Equipes", "Gerenciar Equipes", HyperLink.TypeOfIcon.List),
		new HyperLink("/ManageTeamProjects", "Gerenciar Projetos de equipes", "Gerenciar Projetos de equipes", HyperLink.TypeOfIcon.List),
		new HyperLink("/ManageTeamUsers", "Gerenciar Usuários de equipes", "Gerenciar Usuários de equipes", HyperLink.TypeOfIcon.List),
		new HyperLink("/ProjectToTeam", "Projetos para equipes", "Projetos para equipes", HyperLink.TypeOfIcon.Add),
		new HyperLink("/UserToTeam", "Usuários para equipes", "Usuários para equipes", HyperLink.TypeOfIcon.Add),
	};

	private List<EquipeResponse> teamList = new();
	private List<UsuarioResponse> userList = new();

	private int selectedTeamId;
	private int selectedUserId;

	private string mensageResponse;

	protected override async Task OnInitializedAsync()
	{
		await GetAllTeams();
		await GetAllUsers();
	}

	#region CRUD
	private async Task GetAllTeams()
	{
		try
		{
			teamList = await Http.GetFromJsonAsync<List<EquipeResponse>>("api/Equipe");
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro ao carregar equipes: {ex.Message}";
		}
	}

	private async Task GetAllUsers()
	{
		try
		{
			userList = await Http.GetFromJsonAsync<List<UsuarioResponse>>("api/Usuario");
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro ao carregar usuários: {ex.Message}";
		}
	}

	#endregion

	private async Task AssociateUserToTeam()
	{
		if (selectedUserId == null || selectedTeamId == null)
		{
			mensageResponse = "Por favor, selecione um usuário e uma equipe.";
			return;
		}

		try
		{
			var response = await Http.PostAsync(
				$"api/Equipe/AddUserToTeam/{selectedTeamId}/{selectedUserId}", null);

			if (response.IsSuccessStatusCode)
			{
				mensageResponse = "Usuário vinculado à equipe com sucesso!";
			}
			else
			{
				mensageResponse = "Erro ao vincular: " + await response.Content.ReadAsStringAsync();
			}
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro na requisição: {ex.Message}";
		}
	}

}