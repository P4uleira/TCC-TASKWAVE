@page "/ProjectToTeam"
@rendermode InteractiveServer
@using TASKWAVE.WEB.Components.Layout
@layout NavMenu
@inject HttpClient Http

<PageTitle>Projetos para equipes</PageTitle>

<div class="sidebar" style="width:270px;">
	<NavMenuOptions Options="@Options" />
</div>

<div class="m-md-5">
	<h2>Gerenciar Projetos de equipes</h2>
	<h4 class="mt-3 ">Adicionar Projetos a Equipes</h4>

	<div class="d-flex mt-lg-3">
		<p style="width: 50%">Projeto</p>
		<p style="width: 50%">Equipe</p>
	</div>

	<div class="mb-3 d-flex gap-3">
		<select style="background-color: #333339" class="form-select text-white w-50" @bind="selectedProjectId">
			<option value="">Selecione um projeto</option>
			@foreach (var project in projectList)
			{
				<option value="@project.projectId">@project.projectName</option>
			}
		</select>

		<select style="background-color: #333339" class="form-select text-white w-50" @bind="selectedTeamId">
			<option value="">Selecione uma equipe</option>
			@foreach (var team in teamList)
			{
				<option value="@team.teamId">@team.teamName</option>
			}
		</select>
	</div>
	<div class="d-flex w-100 justify-content-center">
		<button style="background-color: #748CAB" class="btn text-white w-25 rounded-pill mt-xl-5 " @onclick="AssociateProjectToTeam">Vincular Projeto à Equipe</button>
	</div>
	@if (!string.IsNullOrWhiteSpace(mensageResponse))
	{
		<div class="alert alert-info mt-3">@mensageResponse</div>
	}
</div>


@code {

	List<HyperLink> Options = new List<HyperLink>
	{
		new HyperLink("/EquipeCreate", "Criar Equipe", "Criar Equipe", HyperLink.TypeOfIcon.Add),
		new HyperLink("/Equipe", "Gerenciar Equipes", "Gerenciar Equipes", HyperLink.TypeOfIcon.List),
		new HyperLink("/ManageTeamProjects", "Gerenciar Projetos de equipes", "Gerenciar Projetos de equipes", HyperLink.TypeOfIcon.List),
		new HyperLink("/ManageTeamUsers", "Gerenciar Usuários de equipes", "Gerenciar Usuários de equipes", HyperLink.TypeOfIcon.List),
		new HyperLink("/ProjectToTeam", "Projetos para equipes", "Projetos para equipes", HyperLink.TypeOfIcon.Add),
		new HyperLink("/UserToTeam", "Usuários para equipes", "Usuários para equipes", HyperLink.TypeOfIcon.Add),
	};

	private List<EquipeResponse> teamList = new();
	private List<ProjetoResponse> projectList = new();

	private int selectedTeamId;
	private int selectedProjectId;

	private string mensageResponse;

	protected override async Task OnInitializedAsync()
	{
		bool uservalid = await ApiService.SetAuthorizeHeaderAsync();
		if (!uservalid)
		{
			NavigationManager.NavigateTo("/");
		}
		await GetAllTeams();
		await GetAllProjects();
	}

	#region CRUD
	private async Task GetAllTeams()
	{
		try
		{
			teamList = await Http.GetFromJsonAsync<List<EquipeResponse>>("api/Equipe");
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro ao carregar equipes: {ex.Message}";
		}
	}

	private async Task GetAllProjects()
	{
		try
		{
			projectList = await Http.GetFromJsonAsync<List<ProjetoResponse>>("api/Projeto");
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro ao carregar projetos: {ex.Message}";
		}
	}

	#endregion

	private async Task AssociateProjectToTeam()
	{
		if (selectedProjectId == null || selectedTeamId == null)
		{
			mensageResponse = "Por favor, selecione um projeto e uma equipe.";
			return;
		}

		try
		{
			var response = await Http.PostAsync(
				$"api/Equipe/AddProjectToTeam/{selectedTeamId}/{selectedProjectId}", null);

			if (response.IsSuccessStatusCode)
			{
				mensageResponse = "Projeto vinculado à equipe com sucesso!";
			}
			else
			{
				mensageResponse = "Erro ao vincular: " + await response.Content.ReadAsStringAsync();
			}
		}
		catch (Exception ex)
		{
			mensageResponse = $"Erro na requisição: {ex.Message}";
		}
	}

}