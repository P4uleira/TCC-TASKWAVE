@page "/historicoTarefas"
@using TASKWAVE.DTO.Responses
@using TASKWAVE.DTO.Requests
@using System.Net.Http.Json
@using System.Globalization
@using System.Text
@inject HttpClient Http
@rendermode InteractiveServer
@using TASKWAVE.WEB.Components.Layout
@layout NavMenu

<div class="sidebar">
    <NavMenuOptions Options="@Options" />
</div>

<h2 class="mb-4">Histórico de Tarefas</h2>

<div class="d-flex justify-content-between align-items-end mb-3">
    <div class="flex-grow-1 me-2">
        <InputText @bind-Value="FiltroNome" class="form-control bg-dark text-white border-secondary" placeholder="Buscar por nome" />
    </div>
    <div class="d-flex gap-3">
        <InputSelect @bind-Value="FiltroStatus" class="form-select bg-dark text-white border-secondary">
            <option value="">Todos os Status</option>
            <option value="Concluida">Concluída</option>
            <option value="Cancelada">Cancelada</option>
        </InputSelect>
        <InputSelect @bind-Value="FiltroProjetoId" class="form-select bg-dark text-white border-secondary">
            <option value="">Todos os Projetos</option>
            @foreach (var id in listaProjetosIds)
            {
                <option value="@id">@mapaProjetoNomes[id]</option>
            }
        </InputSelect>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(messageResponse))
{
    <div class="alert alert-danger">@messageResponse</div>
}
else if (taskListFiltrada == null)
{
    <p class="text-white">Carregando tarefas...</p>
}
else if (!taskListFiltrada.Any())
{
    <p class="text-white">Nenhuma tarefa encontrada com os filtros aplicados.</p>
}
else
{
    <table class="table table-dark table-bordered table-sm">
        <thead>
            <tr>
                <th>#</th>
                <th></th> <!-- Checkbox -->
                <th>Nome</th>
                <th>Status</th>
                <th>Projeto</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var t in taskListFiltrada.Select((t, index) => new { t, index }))
            {
                <tr>
                    <td>@(t.index + 1)</td>
                    <td>
                        <input type="checkbox" class="form-check-input" />
                    </td>
                    <td>@t.t.taskName</td>
                    <td>
                        <span class="@GetStatusClass(t.t.taskStatus.ToString())">
                            @t.t.taskStatus
                        </span>
                    </td>
                    <td>@(mapaProjetoNomes.ContainsKey(t.t.projectId) ? mapaProjetoNomes[t.t.projectId] : "Projeto desconhecido")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    List<HyperLink> Options = new List<HyperLink>
    {
        new HyperLink("/TarefaCreate", "Criar Tarefa", "Criar Tarefa", HyperLink.TypeOfIcon.Add),
        new HyperLink("/HistoricoTarefa", "Histórico", "Histórico", HyperLink.TypeOfIcon.List),
        new HyperLink("/DesempenhoTarefa", "Desempenho", "Desempenho", HyperLink.TypeOfIcon.List),
        new HyperLink("/CalendarioTarefa", "Calendário", "Calendário", HyperLink.TypeOfIcon.List),
        new HyperLink("/RelatorioTarefa", "Relatórios", "Relatórios", HyperLink.TypeOfIcon.List)
    };

    private List<TarefaResponse> todasAsTarefas = new();
    private List<TarefaResponse> taskListFiltrada = new();
    private List<ProjetoRequest> listaProjetos = new();
    private Dictionary<int, string> mapaProjetoNomes = new();
    private List<int> listaProjetosIds = new();
    private string messageResponse = "";

    private string _filtroNome = "";
    private string FiltroNome
    {
        get => _filtroNome;
        set
        {
            _filtroNome = value;
            _ = OnFiltrar();
        }
    }

    private string _filtroStatus = "";
    private string FiltroStatus
    {
        get => _filtroStatus;
        set
        {
            _filtroStatus = value;
            _ = OnFiltrar();
        }
    }

    private string _filtroProjetoId = "";
    private string FiltroProjetoId
    {
        get => _filtroProjetoId;
        set
        {
            _filtroProjetoId = value;
            _ = OnFiltrar();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var tarefas = await Http.GetFromJsonAsync<List<TarefaResponse>>("api/Tarefa") ?? new();
            todasAsTarefas = tarefas.Where(t =>
                RemoveAccents(t.taskStatus.ToString()).Equals("concluida", StringComparison.OrdinalIgnoreCase) ||
                RemoveAccents(t.taskStatus.ToString()).Equals("cancelada", StringComparison.OrdinalIgnoreCase)
            ).ToList();

            listaProjetos = await Http.GetFromJsonAsync<List<ProjetoRequest>>("api/Projeto") ?? new();
            mapaProjetoNomes = listaProjetos.ToDictionary(p => p.projectId, p => p.projectName);

            listaProjetosIds = todasAsTarefas
                .Select(t => t.projectId)
                .Where(id => mapaProjetoNomes.ContainsKey(id))
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            await OnFiltrar();
        }
        catch (Exception ex)
        {
            messageResponse = $"Erro ao carregar tarefas ou projetos: {ex.Message}";
        }
    }

    private async Task OnFiltrar()
    {
        taskListFiltrada = todasAsTarefas.Where(t =>
            (string.IsNullOrWhiteSpace(FiltroNome) || t.taskName.Contains(FiltroNome, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(FiltroStatus) ||
             RemoveAccents(t.taskStatus.ToString()).Equals(RemoveAccents(FiltroStatus), StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(FiltroProjetoId) || t.projectId.ToString() == FiltroProjetoId)
        ).ToList();

        await InvokeAsync(StateHasChanged);
    }

    private string RemoveAccents(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return input;

        var normalized = input.Normalize(NormalizationForm.FormD);
        var sb = new StringBuilder();
        foreach (var c in normalized)
        {
            if (CharUnicodeInfo.GetUnicodeCategory(c) != UnicodeCategory.NonSpacingMark)
                sb.Append(c);
        }
        return sb.ToString().Normalize(NormalizationForm.FormC);
    }

    private string GetStatusClass(string status)
    {
        var s = RemoveAccents(status).ToLowerInvariant();
        return s switch
        {
            "cancelada" => "text-purple fw-semibold",
            "concluida" => "text-danger fw-semibold",
            _ => "text-secondary"
        };
    }
}

<style>
    .text-purple {
        color: #b17aff !important;
    }
</style>